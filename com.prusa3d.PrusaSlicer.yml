app-id: com.prusa3d.PrusaSlicer
runtime: org.freedesktop.Sdk
runtime-version: "21.08"
sdk: org.freedesktop.Sdk
command: prusa-slicer
# remove this desktop file suffix on stable release
desktop-file-name-suffix: " (Alpha)"
separate-locales: false
finish-args:
  - --share=ipc
  - --socket=x11
  - --device=dri
  - --share=network
  - --device=all
  - --filesystem=home
  - --filesystem=/run/media
  - --filesystem=/media
  # Allow PrusaSlicer to own its session bus. 
  - --own-name=com.prusa3d.prusaslicer.*
  - --system-talk-name=org.freedesktop.UDisks2
  #- --talk-name=org.freedesktop.Flatpak
  - --talk-name=com.prusa3d.prusaslicer.InstanceCheck.*

modules:
  - name: glu
    config-opts:
      - --disable-static
    sources:
      - type: archive
        url: https://mesa.freedesktop.org/archive/glu/glu-9.0.2.tar.xz
        sha256: 6e7280ff585c6a1d9dfcdf2fca489251634b3377bfc33c29e4002466a38d02d4
    cleanup:
      - /include
      - /lib/*.a
      - /lib/*.la
      - /lib/pkgconfig

  - name: glew
    no-autogen: true
    make-args:
      - GLEW_PREFIX=/app
      - GLEW_DEST=/app
      - LIBDIR=/app/lib
    make-install-args:
      - GLEW_PREFIX=/app
      - GLEW_DEST=/app
      - LIBDIR=/app/lib
    sources:
      - type: archive
        url: https://downloads.sourceforge.net/project/glew/glew/2.2.0/glew-2.2.0.tgz
        sha256: d4fc82893cfb00109578d0a1a2337fb8ca335b3ceccf97b97e5cc7f08e4353e1
    cleanup:
      - /include
      - /lib/*.a
      - /lib/pkgconfig

  - name: PrusaSlicer
    buildsystem: simple
    build-commands:
      # start build
      - |
        mkdir -p deps/build && cd deps/build && \
        cmake ../ \
          -DDEP_WX_GTK3=ON \
          -DDEP_DOWNLOAD_DIR=/run/build/PrusaSlicer/external-packages && \
        cmake --build . --target dep_Boost dep_TBB dep_wxWidgets dep_Cereal dep_NLopt dep_OpenVDB dep_OpenCSG dep_CGAL
      - |
        mkdir -p build && cd build && \
        cmake ../ \
          -GNinja \
          -DCMAKE_INSTALL_PREFIX=/app \
          -DCMAKE_INSTALL_LIBDIR=/app/lib \
          -DCMAKE_PREFIX_PATH=/run/build/PrusaSlicer/deps/build/destdir/usr/local \
          -DSLIC3R_FHS=ON \
          -DSLIC3R_GTK=3 \
          -DSLIC3R_STATIC=ON \
          -DSLIC3R_STATIC_EXCLUDE_GLEW=ON \
          -DSLIC3R_STATIC_EXCLUDE_CURL=ON \
          -DSLIC3R_BUILD_TESTS=OFF \
          -DCMAKE_BUILD_TYPE=Release && \
        cmake --build . --target install

    post-install:
      # Desktop Integration Install
      - install -Dm644 com.prusa3d.PrusaSlicer.metainfo.xml /app/share/metainfo/com.prusa3d.PrusaSlicer.metainfo.xml
      - install -Dm644 com.prusa3d.PrusaSlicer.png /app/share/icons/hicolor/128x128/apps/com.prusa3d.PrusaSlicer.png
      - install -Dm644 com.prusa3d.PrusaSlicer.desktop /app/share/applications/com.prusa3d.PrusaSlicer.desktop
      - install -Dm644 com.prusa3d.PrusaSlicer.GCodeViewer.png /app/share/icons/hicolor/128x128/apps/com.prusa3d.PrusaSlicer.GCodeViewer.png
      - install -Dm644 com.prusa3d.PrusaSlicer.GCodeViewer.desktop /app/share/applications/com.prusa3d.PrusaSlicer.GCodeViewer.desktop

    sources:
      # -
      # Section bellow fetches all PrusaSlicer dependencies before the build process and stores them in external-packages/*/* .
      # -DDEP_DOWNLOAD_DIR is set in the build process which has to match with dest.
      #
      # NOTE: The url, dest folder name and sha256 must match from PrusaSlicer's cmake scripts and folder names in PrusaSlicer/deps/
      # -

      # Blosc
      - type: file
        url: https://github.com/tamasmeszaros/c-blosc/archive/refs/heads/v1.17.0_tm.zip
        dest: external-packages/Blosc
        sha256: dcb48bf43a672fa3de6a4b1de2c4c238709dad5893d1e097b8374ad84b1fc3b3

      # Boost
      - type: file
        url: https://boostorg.jfrog.io/artifactory/main/release/1.75.0/source/boost_1_75_0.tar.gz
        dest: external-packages/Boost
        sha256: aeb26f80e80945e82ee93e5939baebdca47b9dee80a07d3144be1e1a6a66dd6a

      # boost_polygon
      - type: file
        url: https://github.com/prusa3d/polygon/archive/refs/heads/prusaslicer_gmp.zip
        dest: external-packages/boost_polygon
        sha256: abeb9710f0a7069fb9b22181ae5c56f6066002f125db210e7ffb27032aed6824

      # Cereal
      - type: file
        url: https://github.com/USCiLab/cereal/archive/v1.2.2.tar.gz
        dest: external-packages/Cereal
        sha256: 1921f26d2e1daf9132da3c432e2fd02093ecaedf846e65d7679ddf868c7289c4

      # CGAL
      - type: file
        url: https://github.com/CGAL/cgal/archive/releases/CGAL-5.0.zip
        dest: external-packages/CGAL
        sha256: c2b035bd078687b6d8c0fb6371a7443adcdb647856af9969532c4050cd5f48e5

      # GMP
      - type: file
        url: https://gmplib.org/download/gmp/gmp-6.2.1.tar.bz2
        dest: external-packages/GMP
        sha256: eae9326beb4158c386e39a356818031bd28f3124cf915f8c5b1dc4c7a36b4d7c

      # JPEG, libjpeg-turbo
      - type: file
        url: https://github.com/libjpeg-turbo/libjpeg-turbo/archive/refs/tags/2.0.6.zip
        dest: external-packages/JPEG
        sha256: 017bdc33ff3a72e11301c0feb4657cb27719d7f97fa67a78ed506c594218bbf1

      # MPFR
      - type: file
        url: http://ftp.vim.org/ftp/gnu/mpfr/mpfr-3.1.6.tar.bz2
        dest: external-packages/MPFR
        sha256: cf4f4b2d80abb79e820e78c8077b6725bbbb4e8f41896783c899087be0e94068

      # NLopt
      - type: file
        url: https://github.com/stevengj/nlopt/archive/v2.5.0.tar.gz
        dest: external-packages/NLopt
        sha256: c6dd7a5701fff8ad5ebb45a3dc8e757e61d52658de3918e38bab233e7fd3b4ae

      # OpenCSG
      - type: file
        url: https://github.com/floriankirsch/OpenCSG/archive/refs/tags/opencsg-1-4-2-release.zip
        dest: external-packages/OpenCSG
        sha256: 51afe0db79af8386e2027d56d685177135581e0ee82ade9d7f2caff8deab5ec5

      # OpenEXR
      - type: file
        url: https://github.com/AcademySoftwareFoundation/openexr/archive/refs/tags/v2.5.5.zip
        dest: external-packages/OpenEXR
        sha256: 0307a3d7e1fa1e77e9d84d7e9a8694583fbbbfd50bdc6884e2c96b8ef6b902de

      # OpenSSL
      - type: file
        url: https://github.com/openssl/openssl/archive/OpenSSL_1_1_0l.tar.gz
        dest: external-packages/OpenSSL
        sha256: e2acf0cf58d9bff2b42f2dc0aee79340c8ffe2c5e45d3ca4533dd5d4f5775b1d

      # OpenVDB
      - type: file
        url: https://github.com/tamasmeszaros/openvdb/archive/refs/tags/v6.2.1-prusa3d.zip
        dest: external-packages/OpenVDB
        sha256: caf9f0c91976722883ff9cb32420ef142af22f7e625fc643b91c23d6e4172f62

      # PNG, libpng
      - type: file
        url: https://github.com/glennrp/libpng/archive/refs/tags/v1.6.35.zip
        dest: external-packages/PNG
        sha256: 3d22d46c566b1761a0e15ea397589b3a5f36ac09b7c785382e6470156c04247f

      # Qhull
      - type: file
        url: https://github.com/qhull/qhull/archive/v8.0.1.zip
        dest: external-packages/Qhull
        sha256: 5287f5edd6a0372588f5d6640799086a4033d89d19711023ef8229dd9301d69b

      # TBB
      - type: file
        url: https://github.com/wjakob/tbb/archive/a0dc9bf76d0120f917b641ed095360448cabc85b.tar.gz
        dest: external-packages/TBB
        sha256: 0545cb6033bd1873fcae3ea304def720a380a88292726943ae3b9b207f322efe

      # TIFF, libtiff
      - type: file
        url: https://gitlab.com/libtiff/libtiff/-/archive/v4.1.0/libtiff-v4.1.0.zip
        dest: external-packages/TIFF
        sha256: c56edfacef0a60c0de3e6489194fcb2f24c03dbb550a8a7de5938642d045bd32

      # wxWidgets, Prusa custom patched
      - type: file
        url: https://github.com/xarbit/wxWidgets/archive/refs/heads/v3.1.5-custom-prusa.zip
        #url: https://github.com/prusa3d/wxWidgets/archive/refs/heads/v3.1.4-patched.zip
        dest: external-packages/wxWidgets
        #sha256: a1e145a083d173cf320c0bd8522c7ee5829052b49b68fe5268ac84f0c576b940
        sha256: 02a698e6f46944fcd29e336a36d3944d79a59d372d239ec0aeb24b574e5a6eee

      # PrusaSlicer Source Archive
      - type: archive
        url: https://github.com/prusa3d/PrusaSlicer/archive/refs/tags/version_2.4.0-alpha1.zip
        sha256: 9612400be0f2fec11cbc712df3e235c225df276ce98f663befd6157dbaefe3b6
      
      # Pre-Build
      - type: shell
        commands: 
          # test wx3.1.5
          - |
            sed -i 's,github.com/prusa3d/wxWidgets/archive/refs/heads/v3.1.4-patched.zip,github.com/xarbit/wxWidgets/archive/refs/heads/v3.1.5-custom-prusa.zip,g' deps/wxWidgets/wxWidgets.cmake
            sed -i 's/a1e145a083d173cf320c0bd8522c7ee5829052b49b68fe5268ac84f0c576b940/02a698e6f46944fcd29e336a36d3944d79a59d372d239ec0aeb24b574e5a6eee/g' deps/wxWidgets/wxWidgets.cmake

          # Set PrusaSlicer version, reference Flathub.org for bug seperation.
          - sed -i 's/+UNKNOWN/+flathub.org/g' version.inc

          - |
            cp resources/icons/PrusaSlicer.png ./com.prusa3d.PrusaSlicer.png
            cp resources/icons/PrusaSlicer-gcodeviewer_128px.png ./com.prusa3d.PrusaSlicer.GCodeViewer.png
            cp src/platform/unix/PrusaSlicer.desktop ./com.prusa3d.PrusaSlicer.desktop
            cp src/platform/unix/PrusaGcodeviewer.desktop ./com.prusa3d.PrusaSlicer.GCodeViewer.desktop
          
          # Append desktop action section to PrusaSlicer.desktop file
          # TODO: remove when #6879 merged
          - |
            cat <<EOT >> com.prusa3d.PrusaSlicer.desktop
              Actions=GCodeViewer;

              [Desktop Action GCodeViewer]
              Exec=prusa-slicer --gcodeviewer %F
              Name=G-Code Viewer
              Name[de]=G-Code Vorschau
              Icon=com.prusa3d.PrusaSlicer.GCodeViewer

            EOT
          
          # Replace icon names with flatpak icon names based on app-id
          - | 
            sed -i 's/Icon=PrusaSlicer-gcodeviewer/Icon=com.prusa3d.PrusaSlicer.GCodeViewer/g' com.prusa3d.PrusaSlicer.GCodeViewer.desktop
            sed -i 's/Icon=PrusaSlicer-gcodeviewer/Icon=com.prusa3d.PrusaSlicer.GCodeViewer/g' com.prusa3d.PrusaSlicer.desktop
            sed -i 's/Icon=PrusaSlicer/Icon=com.prusa3d.PrusaSlicer/g' com.prusa3d.PrusaSlicer.desktop

      # AppData metainfo for Gnome Software & Co.
      - type: file
        path: com.prusa3d.PrusaSlicer.metainfo.xml
