From 12041a80dda5523be45c7811a26267bc8afbc927 Mon Sep 17 00:00:00 2001
From: Elia Devito <eliadevito@gmail.com>
Date: Sun, 31 Mar 2024 13:02:42 +0200
Subject: [PATCH] set default value for url_downloader_dest when PrusaSlicer is
 builded without desktop integration

---
 src/libslic3r/AppConfig.cpp | 26 ++++++++++++++++++++++++++
 1 file changed, 26 insertions(+)

diff --git a/src/libslic3r/AppConfig.cpp b/src/libslic3r/AppConfig.cpp
index 2ab55109c..011ea1583 100644
--- a/src/libslic3r/AppConfig.cpp
+++ b/src/libslic3r/AppConfig.cpp
@@ -30,6 +30,25 @@
 #include <boost/algorithm/hex.hpp>
 #endif
 
+#if defined(__linux__) && !defined(SLIC3R_DESKTOP_INTEGRATION)
+#include <boost/process/system.hpp>
+#include <boost/process/io.hpp>
+
+namespace {
+    std::string get_xdg_download_dir() {
+        boost::process::ipstream os;
+        boost::process::system("xdg-user-dir DOWNLOAD", boost::process::std_out > os);
+
+        std::string download_path;
+
+        if (std::getline(os, download_path))
+            return download_path;
+
+        return "";
+    }
+}
+#endif //defined(__linux__) && !defined(SLIC3R_DESKTOP_INTEGRATION)
+
 namespace Slic3r {
 
 static const std::string VENDOR_PREFIX = "vendor:";
@@ -176,6 +195,13 @@ void AppConfig::set_defaults()
 
         if (get("clear_undo_redo_stack_on_new_project").empty())
             set("clear_undo_redo_stack_on_new_project", "1");
+
+#if defined(__linux__) && !defined(SLIC3R_DESKTOP_INTEGRATION)
+        std::string download_path = get_xdg_download_dir();
+
+        if (!download_path.empty())
+            set("url_downloader_dest", download_path);
+#endif //defined(__linux__) && !defined(SLIC3R_DESKTOP_INTEGRATION)
     }
     else {
 #ifdef _WIN32
-- 
2.44.0

