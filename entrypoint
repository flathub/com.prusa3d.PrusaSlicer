#!/usr/bin/env bash

#set -eo pipefail
#set -m

LOG_FILE=/tmp/com.prusa3d.PrusaSlicer.txt
#export LC_MEASUREMENT=nb_NO.UTF-8nohup
args=("$@")

if [ "$PRUSA_SLICER_DARK_THEME" == "true" ]; then
    export GTK_THEME="Adwaita:dark"
    (prusa-slicer $args &) 2>$LOG_FILE 1>/dev/null && (set-dark-theme-variant.py) &>/dev/null 2>&1
    exec 3<$LOG_FILE
    while read -u 3 -r line; do
        if [[ "$line" == *"An error occured while setting up locale"* ]]; then
            export GTK_THEME="Adwaita:dark"
            export LC_ALL=en_US.UTF-8
            (prusa-slicer $args &) &>/dev/null && (set-dark-theme-variant.py) &>/dev/null 2>&1 && break
            break
        fi
    done
    exec 3<&-
else
    unset GTK_THEME
    (prusa-slicer $args) 2>$LOG_FILE 1>/dev/null &
    exec 4<$LOG_FILE
    while read -u 4 -r line; do
        if [[ "$line" == *"An error occured while setting up locale"* ]]; then
            export LC_ALL=en_US.UTF-8
            (prusa-slicer $args &) &>/dev/null && break
            break
        fi
    done
    exec 4<&-
fi

exit 0
